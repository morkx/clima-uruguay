<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>El tiempo recopilado por Dr. Pachulo</title>

  <link rel="icon" href="img/favicon.ico">
  
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;800&display=swap" rel="stylesheet">

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  
  <style>
    :root {
      --primary-color: #0f172a;
      --accent-color: #3b82f6;
      --card-bg: #ffffff;
      --bg-color: #f1f5f9;
    }

    body {
      font-family: 'Inter', sans-serif;
      background-color: var(--bg-color);
      color: #334155;
    }

    /* Navbar */
    .navbar {
      background-color: var(--primary-color) !important;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    .navbar-brand { font-weight: 800; letter-spacing: -0.5px; }

    /* Header */
    header {
      background: linear-gradient(135deg, #1e293b 0%, #334155 100%);
      color: white;
      padding: 60px 0;
      margin-bottom: -40px;
      padding-bottom: 80px;
    }

    /* Cards */
    .card {
      border: none;
      border-radius: 12px;
      box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
      transition: transform 0.2s;
      overflow: hidden;
      margin-bottom: 20px;
    }
    .card-header {
      background-color: white;
      border-bottom: 1px solid #e2e8f0;
      font-weight: 600;
      padding: 1rem 1.5rem;
    }

    /* Alerts */
    #rain-alert {
      display: none; 
      border-left: 5px solid #dc3545;
      font-weight: 600;
    }
    
    /* Nuevas Alertas CSS */
    #heat-alert {
      display: none;
      border-left: 5px solid #fd7e14; /* Naranja */
      font-weight: 600;
    }
    #cold-alert {
      display: none;
      border-left: 5px solid #0dcaf0; /* Cian/Azul */
      font-weight: 600;
    }
    #wind-alert {
      display: none;
      border-left: 5px solid #ffc107; /* Amarillo */
      font-weight: 600;
    }

    /* Filter */
    #location-filter {
      background: white;
      padding: 20px;
      border-radius: 12px;
      box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
      position: relative;
      z-index: 10;
      margin-top: -30px;
    }

    /* Chart */
    .chart-container { position: relative; height: 350px; width: 100%; }

    footer {
      background-color: var(--primary-color);
      color: #94a3b8;
      padding: 40px 0;
      margin-top: 40px;
    }
  </style>
</head>
<body>

<nav class="navbar navbar-expand-lg navbar-dark fixed-top">
  <div class="container">
    <a class="navbar-brand" href="#"><i class="fa-solid fa-cloud-bolt me-2"></i>Clima Uruguay</a>
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
      <span class="navbar-toggler-icon"></span>
    </button>
    <div class="collapse navbar-collapse" id="navbarNav">
      <ul class="navbar-nav ms-auto">
        <li class="nav-item"><a class="nav-link active" href="#">Dashboard</a></li>
      </ul>
    </div>
  </div>
</nav>

<header class="text-center">
  <div class="container">
    <h1 class="display-5 fw-bold">Estado del Tiempo</h1>
    <p class="lead text-light opacity-75">Monitoreo Nacional &bull; Dr. Pachulo</p>
    
    <div id="rain-alert" class="alert alert-danger mt-4 text-start shadow-lg" role="alert">
      <div class="d-flex align-items-center">
        <i class="fa-solid fa-umbrella fa-2x me-3"></i>
        <div>
          <h5 class="alert-heading mb-0">¡Alerta de Precipitaciones!</h5>
          <p class="mb-0" id="rain-alert-text">Se detecta lluvia en las próximas 2 horas.</p>
        </div>
      </div>
    </div>

    <div id="heat-alert" class="alert alert-warning mt-3 text-start shadow-lg" role="alert">
      <div class="d-flex align-items-center">
        <i class="fa-solid fa-temperature-high fa-2x me-3 text-danger"></i>
        <div>
          <h5 class="alert-heading mb-0">¡Alerta de Calor!</h5>
          <p class="mb-0" id="heat-alert-text">Temperaturas elevadas próximas.</p>
        </div>
      </div>
    </div>

    <div id="cold-alert" class="alert alert-info mt-3 text-start shadow-lg" role="alert">
      <div class="d-flex align-items-center">
        <i class="fa-solid fa-snowflake fa-2x me-3 text-primary"></i>
        <div>
          <h5 class="alert-heading mb-0">¡Alerta de Frío Extremo!</h5>
          <p class="mb-0" id="cold-alert-text">Temperaturas bajo cero próximas.</p>
        </div>
      </div>
    </div>

    <div id="wind-alert" class="alert alert-warning mt-3 text-start shadow-lg" role="alert">
      <div class="d-flex align-items-center">
        <i class="fa-solid fa-wind fa-2x me-3 text-dark"></i>
        <div>
          <h5 class="alert-heading mb-0">¡Alerta de Vientos Fuertes!</h5>
          <p class="mb-0" id="wind-alert-text">Vientos intensos próximos.</p>
        </div>
      </div>
    </div>

  </div>
</header>

<div class="container">
    
    <div id="location-filter" class="mx-auto col-md-8 mb-5">
        <div class="row align-items-center">
            <div class="col-md-4 text-md-end">
                <label for="location-selector" class="fw-bold mb-0">Seleccionar Localidad:</label>
            </div>
            <div class="col-md-8">
                <select id="location-selector" class="form-select form-select-lg">
                    <option value="todos" selected>-- Vista General --</option>
                    
                    <optgroup label="Zona Metropolitana">
                        <option value="montevideo">Montevideo</option>
                        <option value="solymar">Ciudad de la Costa (Solymar)</option>
                        <option value="canelones">Canelones (Capital)</option>
                        <option value="sanjose">San José de Mayo</option>
                    </optgroup>

                    <optgroup label="Este">
                        <option value="maldonado">Maldonado / Punta del Este</option>
                        <option value="rocha">Rocha</option>
                        <option value="treintaytres">Treinta y Tres</option>
                        <option value="lavalleja">Minas (Lavalleja)</option>
                    </optgroup>

                    <optgroup label="Litoral / Oeste">
                        <option value="colonia">Colonia del Sacramento</option>
                        <option value="soriano">Mercedes (Soriano)</option>
                        <option value="rionegro">Fray Bentos (Río Negro)</option>
                        <option value="paysandu">Paysandú</option>
                        <option value="salto">Salto</option>
                        <option value="artigas">Artigas</option>
                    </optgroup>

                    <optgroup label="Centro / Norte">
                        <option value="florida">Florida</option>
                        <option value="flores">Trinidad (Flores)</option>
                        <option value="durazno">Durazno</option>
                        <option value="tacuarembo">Tacuarembó</option>
                        <option value="rivera">Rivera</option>
                        <option value="cerrolargo">Melo (Cerro Largo)</option>
                    </optgroup>
                </select>
            </div>
        </div>
    </div>

    <div class="row mb-4">
        <div class="col-12">
            <div class="card h-100">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <span id="chart-title"><i class="fa-solid fa-chart-line me-2 text-primary"></i>Pronóstico: Solymar</span>
                    <span class="badge bg-primary rounded-pill" id="current-temp-badge">Cargando...</span>
                </div>
                <div class="card-body">
                   <div class="chart-container">
                       <canvas id="weatherChart"></canvas>
                   </div>
                   <div class="row mt-3 text-center small text-muted">
                        <div class="col-3 border-end">
                            <strong class="d-block text-dark" id="val-uv">--</strong> Índice UV Max
                        </div>
                        <div class="col-3 border-end">
                            <strong class="d-block text-dark" id="val-wind">-- km/h</strong> Viento (Ahora)
                        </div>
                        <div class="col-3 border-end">
                            <strong class="d-block text-dark" id="val-humidity">--%</strong> Humedad
                        </div>
                        <div class="col-3">
                            <strong class="d-block text-dark" id="val-pressure">-- hPa</strong> Presión
                        </div>
                   </div>
                </div>
            </div>
        </div>
    </div>

    <div id="widget-sections" class="row">
        
        <div class="col-lg-6 mb-4">
            <div class="card h-100">
                <div class="card-header">Mapa Sinóptico (Viento/Temp)</div>
                <div class="card-body p-0">
                    <iframe id="windy-map-iframe" width="100%" height="400" src="" frameborder="0" style="border-radius: 0 0 12px 12px;"></iframe>
                </div>
            </div>
        </div>

        <div class="col-lg-6 mb-4">
            <div class="card h-100">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <span>Satélite GOES-19 (GeoColor)</span>
                    <span class="badge bg-success rounded-pill">En Vivo</span>
                </div>
                <div class="card-body p-0 d-flex align-items-center justify-content-center bg-black">
                    <img id="goes-gif" src="https://cdn.star.nesdis.noaa.gov/GOES19/ABI/SECTOR/ssa/GEOCOLOR/GOES19-SSA-GEOCOLOR-900x540.gif" alt="Satélite GOES-19" class="img-fluid" style="max-height: 400px; width: auto;">
                </div>
            </div>
        </div>

        <div class="col-lg-6 mb-4 widget-wrapper" data-location="solymar">
            <div class="card h-100">
                <div class="card-header">Windguru (Solymar)</div>
                <div class="card-body text-center overflow-auto">
                    <script id="wg_fwdg_313166_29_1770925276942">
                    (function (window, document) {
                      var loader = function () {
                        var arg = ["s=313166" ,"m=29","uid=wg_fwdg_313166_29_1770925276942" ,"wj=knots" ,"tj=c" ,"waj=m" ,"tij=cm" ,"odh=0" ,"doh=24" ,"fhours=48" ,"hrsm=2" ,"vt=forecasts" ,"lng=es" ,"p=WINDSPD,GUST,TMPE,TCDC,APCP1s,RH"];
                        var script = document.createElement("script");
                        var tag = document.getElementsByTagName("script")[0];
                        script.src = "https://www.windguru.cz/js/widget.php?"+(arg.join("&"));
                        tag.parentNode.insertBefore(script, tag);
                      };
                      window.addEventListener ? window.addEventListener("load", loader, false) : window.attachEvent("onload", loader);
                    })(window, document);
                    </script>
                </div>
            </div>
        </div>

        <div class="col-lg-6 mb-4 widget-wrapper" data-location="montevideo">
            <div class="card h-100">
                <div class="card-header">Windguru (Montevideo)</div>
                <div class="card-body text-center overflow-auto">
                <script id="wg_fwdg_1253312_29_1770925453253">
                (function (window, document) {
                  var loader = function () {
                    var arg = ["s=1253312" ,"m=29","uid=wg_fwdg_1253312_29_1770925453253","ai=0" ,"wj=knots" ,"tj=c" ,"waj=m" ,"tij=cm" ,"odh=0" ,"doh=24" ,"fhours=240" ,"hrsm=2" ,"vt=forecasts" ,"lng=es" ,"p=WINDSPD,GUST,TMPE,TCDC,APCP1s,RH"];
                    var script = document.createElement("script");
                    var tag = document.getElementsByTagName("script")[0];
                    script.src = "https://www.windguru.cz/js/widget.php?"+(arg.join("&"));
                    tag.parentNode.insertBefore(script, tag);
                  };
                  window.addEventListener ? window.addEventListener("load", loader, false) : window.attachEvent("onload", loader);
                })(window, document);
                </script>
                </div>
            </div>
        </div>
        
    </div>
</div>

<footer>
  <div class="container text-center">
    <p class="mb-1">&copy; 2026 Clima Uruguay.</p>
    <small>Datos provistos por Open-Meteo API, Windguru, Windy & NOAA.</small>
  </div>
</footer>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        
        // --- 0. Configuración de Coordenadas Completa ---
        const coords = {
            'solymar': { lat: -34.82, lon: -55.95, name: 'Solymar (Cd. Costa)' },
            'montevideo': { lat: -34.90, lon: -56.16, name: 'Montevideo' },
            'canelones': { lat: -34.52, lon: -56.28, name: 'Canelones' },
            'maldonado': { lat: -34.90, lon: -54.95, name: 'Maldonado' },
            'rocha': { lat: -34.48, lon: -54.33, name: 'Rocha' },
            'treintaytres': { lat: -33.23, lon: -54.38, name: 'Treinta y Tres' },
            'cerrolargo': { lat: -32.37, lon: -54.17, name: 'Melo' },
            'rivera': { lat: -30.90, lon: -55.55, name: 'Rivera' },
            'artigas': { lat: -30.40, lon: -56.46, name: 'Artigas' },
            'salto': { lat: -31.38, lon: -57.96, name: 'Salto' },
            'paysandu': { lat: -32.32, lon: -58.08, name: 'Paysandú' },
            'rionegro': { lat: -33.13, lon: -58.30, name: 'Fray Bentos' },
            'soriano': { lat: -33.25, lon: -58.03, name: 'Mercedes' },
            'colonia': { lat: -34.46, lon: -57.84, name: 'Colonia del Sacramento' },
            'sanjose': { lat: -34.34, lon: -56.71, name: 'San José de Mayo' },
            'flores': { lat: -33.52, lon: -56.90, name: 'Trinidad' },
            'florida': { lat: -34.10, lon: -56.21, name: 'Florida' },
            'durazno': { lat: -33.38, lon: -56.53, name: 'Durazno' },
            'tacuarembo': { lat: -31.71, lon: -55.98, name: 'Tacuarembó' },
            'lavalleja': { lat: -34.38, lon: -55.24, name: 'Minas' },
            'todos': { lat: -34.82, lon: -55.95, name: 'General' } 
        };

        let myChart = null; 

        // --- 1. Lógica del Filtro y Actualización ---
        const selector = document.getElementById('location-selector');
        const widgets = document.querySelectorAll('.widget-wrapper');
        const windyMapIframe = document.getElementById('windy-map-iframe');

        function updateDashboard() {
            const selectedKey = selector.value;
            
            // 1. Filtrar Widgets (Windguru solo para MVD/Solymar)
            widgets.forEach(widget => {
                if (!widget.hasAttribute('data-location')) return;
                const locations = widget.getAttribute('data-location').split(' ');

                if (selectedKey === 'todos') {
                    widget.style.display = 'none'; 
                } else if (locations.includes(selectedKey)) {
                    widget.style.display = 'block';
                } else {
                    widget.style.display = 'none';
                }
            });

            // 2. Obtener Coordenadas
            const locData = coords[selectedKey] || coords['solymar'];
            
            // 3. Título del Gráfico
            document.getElementById('chart-title').innerHTML = `<i class="fa-solid fa-chart-line me-2 text-primary"></i>Pronóstico: ${locData.name}`;

            // 4. ACTUALIZAR MAPA SINÓPTICO (WINDY)
            if (windyMapIframe) {
                // Si es "todos", usamos zoom lejano, si es departamento, zoom cercano
                const zoom = selectedKey === 'todos' ? 6 : 9;
                
                // Url de Windy tipo "map" (Sinóptico) centrada en el departamento
                const newSrc = `https://embed.windy.com/embed.html?type=map&location=coordinates&metricRain=default&metricTemp=default&metricWind=default&zoom=${zoom}&overlay=rain&product=ecmwf&level=surface&lat=${locData.lat}&lon=${locData.lon}&detailLat=${locData.lat}&detailLon=${locData.lon}&detail=true&message=true`;
                windyMapIframe.src = newSrc;
            }

            // 5. Obtener datos Open-Meteo
            fetchWeatherData(locData.lat, locData.lon);
        }

        selector.addEventListener('change', updateDashboard);
        

        // --- 2. Función Datos Open-Meteo ---
        function fetchWeatherData(lat, lon) {
            const apiUrl = `https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&daily=sunset,sunrise,uv_index_max&hourly=temperature_2m,rain,precipitation_probability,relative_humidity_2m,pressure_msl,wind_speed_10m&timezone=auto&past_days=1&forecast_days=3`;

            document.getElementById('current-temp-badge').innerText = "Cargando...";
            document.getElementById('current-temp-badge').className = "badge bg-secondary rounded-pill";

            fetch(apiUrl)
                .then(response => response.json())
                .then(data => {
                    processWeatherData(data);
                })
                .catch(error => {
                    console.error("Error API:", error);
                    document.getElementById('current-temp-badge').innerText = "Error";
                    document.getElementById('current-temp-badge').className = "badge bg-danger rounded-pill";
                });
        }

        function processWeatherData(data) {
            const hourly = data.hourly;
            const now = new Date();
            let currentIndex = 0;

            const currentIsoHour = now.toISOString().slice(0, 13);
            
            for(let i=0; i < hourly.time.length; i++) {
                if(hourly.time[i].startsWith(currentIsoHour)) {
                    currentIndex = i;
                    break;
                }
            }

            const currentTemp = hourly.temperature_2m[currentIndex];
            const currentWind = hourly.wind_speed_10m[currentIndex];
            const currentHum = hourly.relative_humidity_2m[currentIndex];
            const currentPress = hourly.pressure_msl[currentIndex];
            const maxUvToday = data.daily.uv_index_max[1] || data.daily.uv_index_max[0]; 

            document.getElementById('current-temp-badge').innerText = `Ahora: ${currentTemp}°C`;
            document.getElementById('current-temp-badge').className = "badge bg-primary rounded-pill";
            document.getElementById('val-wind').innerText = `${currentWind} km/h`;
            document.getElementById('val-humidity').innerText = `${currentHum}%`;
            document.getElementById('val-pressure').innerText = `${currentPress} hPa`;
            document.getElementById('val-uv').innerText = maxUvToday;

            // --- LÓGICA DE ALERTAS ---
            let rainWarning = false;
            let rainDetails = "";
            
            let heatWarning = false;
            let heatDetails = "";
            
            let coldWarning = false;
            let coldDetails = "";
            
            let windWarning = false;
            let windDetails = "";

            const alertBoxRain = document.getElementById('rain-alert');
            const alertBoxHeat = document.getElementById('heat-alert');
            const alertBoxCold = document.getElementById('cold-alert');
            const alertBoxWind = document.getElementById('wind-alert');

            // Revisamos próximas 2 horas (índice actual y siguiente)
            for(let j=0; j<2; j++) {
                let idx = currentIndex + j;
                if (idx >= hourly.precipitation_probability.length) break;

                // Lluvia
                let prob = hourly.precipitation_probability[idx];
                let mm = hourly.rain[idx];
                if (prob >= 50 || mm > 0.1) {
                    rainWarning = true;
                    rainDetails = `Probabilidad: ${prob}% - Intensidad: ${mm}mm`;
                }
                
                // Temperatura (Calor > 30, Frío < 0)
                let temp = hourly.temperature_2m[idx];
                if (temp > 30) {
                    heatWarning = true;
                    heatDetails = `Pico estimado: ${temp}°C`;
                }
                if (temp < 0) {
                    coldWarning = true;
                    coldDetails = `Mínima estimada: ${temp}°C`;
                }
                
                // Viento (> 60 km/h)
                let wind = hourly.wind_speed_10m[idx];
                if (wind > 60) {
                    windWarning = true;
                    windDetails = `Ráfagas: ${wind} km/h`;
                }
            }

            // Mostrar/Ocultar Alertas
            alertBoxRain.style.display = rainWarning ? 'block' : 'none';
            if(rainWarning) document.getElementById('rain-alert-text').innerText = `Se detecta lluvia en las próximas 2 horas. (${rainDetails})`;

            alertBoxHeat.style.display = heatWarning ? 'block' : 'none';
            if(heatWarning) document.getElementById('heat-alert-text').innerText = `Temperaturas superiores a 30°C en las próximas 2 horas. (${heatDetails})`;

            alertBoxCold.style.display = coldWarning ? 'block' : 'none';
            if(coldWarning) document.getElementById('cold-alert-text').innerText = `Temperaturas bajo cero en las próximas 2 horas. (${coldDetails})`;

            alertBoxWind.style.display = windWarning ? 'block' : 'none';
            if(windWarning) document.getElementById('wind-alert-text').innerText = `Vientos superiores a 60 km/h en las próximas 2 horas. (${windDetails})`;


            // Gráfico
            const sliceStart = Math.max(0, currentIndex - 6);
            const sliceEnd = Math.min(hourly.time.length, currentIndex + 42);

            const labels = hourly.time.slice(sliceStart, sliceEnd).map(t => {
                const date = new Date(t);
                return date.getHours() + ':00';
            });
            const tempData = hourly.temperature_2m.slice(sliceStart, sliceEnd);
            const rainProbData = hourly.precipitation_probability.slice(sliceStart, sliceEnd);

            const ctx = document.getElementById('weatherChart').getContext('2d');
            
            if (myChart) {
                myChart.destroy();
            }

            myChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: 'Temperatura (°C)',
                            data: tempData,
                            type: 'line',
                            borderColor: '#ef4444',
                            backgroundColor: 'rgba(239, 68, 68, 0.1)',
                            borderWidth: 3,
                            tension: 0.4,
                            yAxisID: 'y',
                            pointRadius: 0,
                            pointHoverRadius: 6
                        },
                        {
                            label: 'Prob. Lluvia (%)',
                            data: rainProbData,
                            type: 'bar',
                            backgroundColor: 'rgba(59, 130, 246, 0.6)',
                            yAxisID: 'y1',
                            borderRadius: 4
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: { mode: 'index', intersect: false },
                    plugins: {
                        legend: { position: 'top' },
                        tooltip: {
                            backgroundColor: 'rgba(15, 23, 42, 0.9)',
                            padding: 10,
                            cornerRadius: 8
                        }
                    },
                    scales: {
                        x: { grid: { display: false } },
                        y: {
                            type: 'linear', display: true, position: 'left',
                            title: { display: true, text: 'Temp (°C)' }
                        },
                        y1: {
                            type: 'linear', display: true, position: 'right',
                            min: 0, max: 100,
                            grid: { drawOnChartArea: false },
                            title: { display: true, text: 'Prob. Lluvia (%)' }
                        }
                    }
                }
            });
        }

        // --- 3. Actualización Automática del GIF de NOAA ---
        setInterval(function() {
            const img = document.getElementById('goes-gif');
            const currentSrc = img.src.split('?')[0];
            img.src = currentSrc + '?t=' + new Date().getTime();
        }, 3600000); 

        // Inicializar Dashboard
        updateDashboard();
    });
</script>
</body>
</html>